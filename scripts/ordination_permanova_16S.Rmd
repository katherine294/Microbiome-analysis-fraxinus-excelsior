--
title: "beta-final"
output: html_document
date: "2025-08-06"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library("phyloseq")
library("ggplot2")      # graphics
library("vegan")
library("microbiome")
library("RColorBrewer")
library("dplyr")
library("pairwiseAdonis")
library("ape")
library("phytools")
library(readr)
options(bitmapType='cairo')


```



Load data using phyloseq
```{r}
#read metadata
dataset <- read.csv("/rds/homes/k/kgh742/psf_wgs_project/02.MicrobiomeAnalysis/Metadata_microbiome.csv")
rownames(dataset) <- dataset$Sample_name        ##Rownames may not be recognised (used sample_names() to check)
dataset[] <- lapply(dataset, as.factor)

#read taxa, if starting fro here
taxa <- (read.csv("/rds/homes/k/kgh742/psf_wgs_project/02.MicrobiomeAnalysis/16S_Raw/tax_table_16S.csv"))
taxa <- taxa %>% 
  tibble::column_to_rownames("X")
taxa <-as.matrix(taxa)

#load ASV table, if starting from here
library(data.table)
seqtab.nochim <- fread("/rds/homes/k/kgh742/psf_wgs_project/02.MicrobiomeAnalysis/16S_Raw/ASV_table_16s.csv")
seqtab.nochim <- seqtab.nochim %>% 
  tibble::column_to_rownames("V1")
seqtab.nochim <- otu_table(seqtab.nochim , taxa_are_rows=FALSE)

##Create phyloseq object. Sample data needs to provide information about the samples
ps <- phyloseq(otu_table(seqtab.nochim, taxa_are_rows=FALSE), sample_data(dataset), tax_table(taxa))

##Assign the taxa names instead of DNA sequences to the OTU table and DNA sequneces as reference sequences
dna <- Biostrings::DNAStringSet(taxa_names(ps))
names(dna) <- taxa_names(ps)
ps <- merge_phyloseq(ps, dna)
taxa_names <- paste0("ASV", seq(ntaxa(ps)))
ps

#subsetting to remove mitochondria and chloroplast
ps.clean = subset_taxa(ps, Order != "Chloroplast" & Family != "Mitochondria")

tree <- read.tree("/rds/homes/k/kgh742/psf_wgs_project/02.MicrobiomeAnalysis/16S_fasttree_030225.nwk")
print(tree)

# Tree must be rooted for Fait's PD index. Root the tree using midpoint rooting. I used a random outgroup from my dataset.
tree_rooted <- midpoint.root(tree) # Root the tree

is.rooted(tree_rooted) #check if it worked

ps.clean <- merge_phyloseq(ps.clean, phy_tree(tree_rooted)) #merge to phyloseq object 

ps <- ps.clean

```
Filtering 
```{r}
# 1. OPTIONAL !!! Prune to X (e.g. 1,000) read depth - i had a weird sample with only 450 that was skewing results --------
ps_filtered0 <- prune_samples(sample_sums(ps) >= 1000, ps)

# Keep ASVs with â‰¥10 total reads across all samples
ps_filtered01 <- prune_taxa(taxa_sums(ps_filtered0) >= 10, ps_filtered0)

# Check how many taxa you removed
cat("Before filtering:", ntaxa(ps), "taxa\n") # 18308
cat("After filtering:", ntaxa(ps_filtered0), "taxa\n") # 18308
cat("After filtering:", ntaxa(ps_filtered01), "taxa\n") # 11931
```

Add metadata
```{r}
# Create a site_tree variable to test for tree 
sample_data(ps_filtered01)$Site_Tree <- factor(paste(sample_data(ps_filtered01)$Site, sample_data(ps_filtered01)$Tree, sep = "_"))

# Create a site_tree variable to test for tree 
sample_data(ps_filtered01)$Site_Tissue <- factor(paste(sample_data(ps_filtered01)$Site, sample_data(ps_filtered01)$Tissue_health, sep = "_"))

# Extract metadata as dataframe
ps1.meta <- as(sample_data(ps_filtered01), "data.frame")

# Add read depth and z-score normalization
read_depth <- sample_sums(ps_filtered01)
ps1.meta$ReadDepth <- read_depth[rownames(ps1.meta)]
ps1.meta$ReadDepth_z <- scale(ps1.meta$ReadDepth)

# Add back to phyloseq object
sample_data(ps_filtered01) <- sample_data(ps1.meta)

# Optional sanity check
head(sample_data(ps_filtered01)$ReadDepth)
head(sample_data(ps_filtered01)$ReadDepth_z)
```

Transforming data
```{r}
ps0 <- microbiome::transform(ps_filtered01,"compositional")
```

```{r}
ordu = ordinate(ps0, "PCoA", "wunifrac")
plot_ordination(ps0, ordu, color="Tissue_health", shape = "Site")  + scale_colour_brewer(palette="Paired") + geom_point(size=3) +stat_ellipse()
```
