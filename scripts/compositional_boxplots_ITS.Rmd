---
title: "filtered_composition"
output: html_document
date: "2025-08-03"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

`## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
library(phyloseq)
library(ALDEx2)
library(dplyr)
library(ggplot2)
library(tibble)
library(microViz)
library(microbiomeutilities) # For taxa_summary
library(readr)
library(phytools)

options(bitmapType='cairo')

```

Load data using phyloseq
```{r, include=FALSE}
#read metadata
dataset <- read.csv("/rds/homes/k/kgh742/psf_wgs_project/02.MicrobiomeAnalysis/ITS_Analysis/Metadata_microbiome.csv")
rownames(dataset) <- dataset$Sample_name        ##Rownames may not be recognised (used sample_names() to check)
dataset[] <- lapply(dataset, as.factor)

#read taxa, created using the DADA2 pipeline
taxa <- (read.csv("/rds/homes/k/kgh742/psf_wgs_project/02.MicrobiomeAnalysis/ITS_Analysis/tax_table.csv"))
taxa <- taxa %>% 
  tibble::column_to_rownames("X")
taxa <-as.matrix(taxa)

#load ASV table, created using DADA2 pipeline
library(data.table)
seqtab.nochim <- fread("/rds/homes/k/kgh742/psf_wgs_project/02.MicrobiomeAnalysis/ITS_Analysis/ASV_table.csv")
seqtab.nochim <- seqtab.nochim %>% 
  tibble::column_to_rownames("V1")

common_samples <- intersect(rownames(dataset), rownames(seqtab.nochim))
dataset_filt <- dataset[common_samples, , drop = FALSE]
seqtab_filt <- seqtab.nochim[common_samples, , drop = FALSE]

##Create phyloseq object. Sample data needs to provide information about the samples
ps <- phyloseq(otu_table(seqtab.nochim, taxa_are_rows=FALSE), sample_data(dataset_filt), tax_table(taxa))

##Assign the taxa names instead of DNA sequences to the OTU table and DNA sequneces as reference sequences
dna <- Biostrings::DNAStringSet(taxa_names(ps))
names(dna) <- taxa_names(ps)
ps <- merge_phyloseq(ps, dna)
taxa_names(ps) <- paste0("ASV", seq(ntaxa(ps)))
ps

taxa_names(ps)

tree <- read.tree("/rds/homes/k/kgh742/psf_wgs_project/02.MicrobiomeAnalysis/ITS_Analysis/ITS_ASV_fasttreE.nwk")
print(tree)

# Tree must be rooted for Fait's PD index. Root the tree using midpoint rooting. I used a random outgroup from my dataset.
tree_rooted <- midpoint.root(tree) # Root the tree
is.rooted(tree_rooted) #check if it worked

ps_tree <- merge_phyloseq(ps, phy_tree(tree_rooted)) #merge to phyloseq object 

taxa_names(ps_tree)

sample_data(ps_tree)$Site_Tree <- factor(paste(sample_data(ps_tree)$Site, sample_data(ps_tree)$Tree, sep = "_"))
sample_data(ps_tree)$Site_tissue <- factor(paste(sample_data(ps_tree)$Site, sample_data(ps_tree)$Tissue_health, sep = "_"))

# 1. OPTIONAL !!! Prune to X (e.g. 1,000) read depth - i had a weird sample with only 450 that was skewing results --------
ps_filt <- prune_samples(sample_sums(ps_tree) >= 1000, ps_tree)

# Keep ASVs with ≥10 total reads across all samples
ps_filtered01 <- prune_taxa(taxa_sums(ps_filt) >= 10, ps_filt)

# Check how many taxa you removed
cat("Before filtering:", ntaxa(ps), "taxa\n") # 4454 
cat("After filtering:", ntaxa(ps_filt), "taxa\n") # 4454 
cat("After filtering:", ntaxa(ps_filtered01), "taxa\n") # 2306 
# cat("After filtering:", ntaxa(ps_filtered02), "taxa\n") #  4506 taxa

```


Order samples for barplot
```{r}
lkd <- c(
  "LA1B1ITS", "LA1B2ITS", "LA1B3ITS", "LA1B4ITS", "LA1B5ITS", "LA1B6ITS",
  "LA2B1ITS", "LA2B2ITS", "LA2B3ITS", "LA2B4ITS", "LA2B5ITS", "LA2B6ITS",
  "LA3B2ITS", "LA3B3ITS", "LA3B4ITS", "LA3B5ITS", "LA3B6ITS",
  "LA4B1ITS", "LA4B2ITS", "LA4B3ITS", "LA4B4ITS", "LA4B5ITS", "LA4B6ITS",
  "LA5B1ITS", "LA5B2ITS", "LA5B3ITS", "LA5B4ITS", "LA5B5ITS", "LA5B6ITS",
  "LA6B1ITS", "LA6B2ITS", "LA6B3ITS", "LA6B4ITS", "LA6B5ITS", "LA6B6ITS", "LA6B7ITS",
  "LA7B1ITS",
  "LA8B1ITS", "LA8B2ITS", "LA8B3ITS",
  "LA9B2ITS", "LA9B3ITS",
  "LA11B1ITS", "LA11B2ITS", "LA11B3ITS",
  "LA12B1ITS"
)

w_order <- c(
  "WA1B1ITS", "WA1B2ITS", "WA1B3ITS", "WA1B4ITS", "WA1B5ITS", "WA1B6ITS",
  "WA2B2ITS", "WA2B3ITS", "WA2B4ITS", "WA2B5ITS", "WA2B6ITS",
  "WA3B1ITS", "WA3B2ITS", "WA3B3ITS", "WA3B4ITS", "WA3B5ITS", "WA3B6ITS",
  "WA4B1ITS", "WA4B3ITS", "WA4B4ITS", "WA4B5ITS", "WA4B6ITS",
  "WA5B1ITS", "WA5B2ITS", "WA5B3ITS", "WA5B4ITS", "WA5B5ITS", "WA5B6ITS",
  "WA7B1ITS", "WA7B2ITS", "WA7B3ITS",
  "WA8B1ITS", "WA8B2ITS", "WA8B3ITS",
  "WA9B1ITS", "WA9B2ITS", "WA9B3ITS",
  "WA10B1ITS", "WA10B2ITS", "WA10B3ITS",
  "WA11B1ITS", "WA11B2ITS", "WA11B3ITS",
  "WA12B1ITS", "WA12B2ITS", "WA12B3ITS"
)


# Combine your sample IDs into one desired order
ordered_ids <- c(lkd, w_order)
```

Filtering 
```{r}
# 1. Prevalence filtering for beta and differential abnudance testing - HIGHLY RECOMMENDED --------
# Get total number of samples
total_samples <- nsamples(ps_filtered01)
# Define minimum number of samples a taxon must be present in (e.g. ≥10% = 0.1)
min_prevalence <- ceiling(0.05 * total_samples)
# Filter taxa based on prevalence
ps_filtered02 <- filter_taxa(ps_filtered01, function(x) sum(x > 0) >= min_prevalence, prune = TRUE)

# Check how many taxa you removed
cat("Before filtering:", ntaxa(ps), "taxa\n") # 4454 
cat("After filtering:", ntaxa(ps_filt), "taxa\n") # 4454 
cat("After filtering:", ntaxa(ps_filtered01), "taxa\n") # 2306 
cat("After filtering:", ntaxa(ps_filtered02), "taxa\n") #  656  taxa
```

Run plot_taxonomic_barplot function for each level - change output directpry in function.
```{r}
# requirements
library(phyloseq)
library(dplyr)
library(ggplot2)
library(microbiome)

plot_taxonomic_barplot(ps_filtered02, "Phylum", n_taxa = 15)
plot_taxonomic_barplot(ps_filtered02, "Class", n_taxa = 15)
plot_taxonomic_barplot(ps_filtered02, "Order", n_taxa = 15)
plot_taxonomic_barplot(ps_filtered02, "Family", n_taxa = 20)
plot_taxonomic_barplot(ps_filtered02, "Genus", n_taxa = 30)
```                      

Make barplot comparing compositional data between tissue health - top most abundant only. 
```{r}
tax_levels <- c("Phylum", "Class", "Order", "Family", "Genus")

for (lvl in tax_levels) {
  plot_top_taxa_by_group(
    ps_filtered02, 
    tax_level = lvl, 
    top_n = 20, 
    out_dir = "/rds/homes/k/kgh742/psf_wgs_project/02.MicrobiomeAnalysis/ITS_Figures/composition_barplots/"
  )
}
```
