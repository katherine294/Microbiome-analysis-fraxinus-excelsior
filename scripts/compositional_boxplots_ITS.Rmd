---
title: "filtered_composition"
output: html_document
date: "2025-08-03"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

`## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
library(phyloseq)
library(ALDEx2)
library(dplyr)
library(ggplot2)
library(tibble)
library(microViz)
library(microbiomeutilities) # For taxa_summary
library(readr)
library(phytools)

options(bitmapType='cairo')

```

Load data using phyloseq
```{r, include=FALSE}
#read metadata
dataset <- read.csv("/rds/homes/k/kgh742/psf_wgs_project/02.MicrobiomeAnalysis/ITS_Analysis/Metadata_microbiome.csv")
rownames(dataset) <- dataset$Sample_name        ##Rownames may not be recognised (used sample_names() to check)
dataset[] <- lapply(dataset, as.factor)

#read taxa, created using the DADA2 pipeline
taxa <- (read.csv("/rds/homes/k/kgh742/psf_wgs_project/02.MicrobiomeAnalysis/ITS_Analysis/tax_table.csv"))
taxa <- taxa %>% 
  tibble::column_to_rownames("X")
taxa <-as.matrix(taxa)

#load ASV table, created using DADA2 pipeline
library(data.table)
seqtab.nochim <- fread("/rds/homes/k/kgh742/psf_wgs_project/02.MicrobiomeAnalysis/ITS_Analysis/ASV_table.csv")
seqtab.nochim <- seqtab.nochim %>% 
  tibble::column_to_rownames("V1")

common_samples <- intersect(rownames(dataset), rownames(seqtab.nochim))
dataset_filt <- dataset[common_samples, , drop = FALSE]
seqtab_filt <- seqtab.nochim[common_samples, , drop = FALSE]

##Create phyloseq object. Sample data needs to provide information about the samples
ps <- phyloseq(otu_table(seqtab.nochim, taxa_are_rows=FALSE), sample_data(dataset_filt), tax_table(taxa))

##Assign the taxa names instead of DNA sequences to the OTU table and DNA sequneces as reference sequences
dna <- Biostrings::DNAStringSet(taxa_names(ps))
names(dna) <- taxa_names(ps)
ps <- merge_phyloseq(ps, dna)
taxa_names(ps) <- paste0("ASV", seq(ntaxa(ps)))
ps

taxa_names(ps)

tree <- read.tree("/rds/homes/k/kgh742/psf_wgs_project/02.MicrobiomeAnalysis/ITS_Analysis/ITS_ASV_fasttreE.nwk")
print(tree)

# Tree must be rooted for Fait's PD index. Root the tree using midpoint rooting. I used a random outgroup from my dataset.
tree_rooted <- midpoint.root(tree) # Root the tree
is.rooted(tree_rooted) #check if it worked

ps_tree <- merge_phyloseq(ps, phy_tree(tree_rooted)) #merge to phyloseq object 

taxa_names(ps_tree)

sample_data(ps_tree)$Site_Tree <- factor(paste(sample_data(ps_tree)$Site, sample_data(ps_tree)$Tree, sep = "_"))
sample_data(ps_tree)$Site_tissue <- factor(paste(sample_data(ps_tree)$Site, sample_data(ps_tree)$Tissue_health, sep = "_"))

# 1. OPTIONAL !!! Prune to X (e.g. 1,000) read depth - i had a weird sample with only 450 that was skewing results --------
ps_filt <- prune_samples(sample_sums(ps_tree) >= 1000, ps_tree)

# Keep ASVs with ≥10 total reads across all samples
ps_filtered01 <- prune_taxa(taxa_sums(ps_filt) >= 10, ps_filt)

# Check how many taxa you removed
cat("Before filtering:", ntaxa(ps), "taxa\n") # 4454 
cat("After filtering:", ntaxa(ps_filt), "taxa\n") # 4454 
cat("After filtering:", ntaxa(ps_filtered01), "taxa\n") # 2306 
# cat("After filtering:", ntaxa(ps_filtered02), "taxa\n") #  4506 taxa

```


Order samples for barplot
```{r}
lkd <- c(
  "LA1B1ITS", "LA1B2ITS", "LA1B3ITS", "LA1B4ITS", "LA1B5ITS", "LA1B6ITS",
  "LA2B1ITS", "LA2B2ITS", "LA2B3ITS", "LA2B4ITS", "LA2B5ITS", "LA2B6ITS",
  "LA3B2ITS", "LA3B3ITS", "LA3B4ITS", "LA3B5ITS", "LA3B6ITS",
  "LA4B1ITS", "LA4B2ITS", "LA4B3ITS", "LA4B4ITS", "LA4B5ITS", "LA4B6ITS",
  "LA5B1ITS", "LA5B2ITS", "LA5B3ITS", "LA5B4ITS", "LA5B5ITS", "LA5B6ITS",
  "LA6B1ITS", "LA6B2ITS", "LA6B3ITS", "LA6B4ITS", "LA6B5ITS", "LA6B6ITS", "LA6B7ITS",
  "LA7B1ITS",
  "LA8B1ITS", "LA8B2ITS", "LA8B3ITS",
  "LA9B2ITS", "LA9B3ITS",
  "LA11B1ITS", "LA11B2ITS", "LA11B3ITS",
  "LA12B1ITS"
)

w_order <- c(
  "WA1B1ITS", "WA1B2ITS", "WA1B3ITS", "WA1B4ITS", "WA1B5ITS", "WA1B6ITS",
  "WA2B2ITS", "WA2B3ITS", "WA2B4ITS", "WA2B5ITS", "WA2B6ITS",
  "WA3B1ITS", "WA3B2ITS", "WA3B3ITS", "WA3B4ITS", "WA3B5ITS", "WA3B6ITS",
  "WA4B1ITS", "WA4B3ITS", "WA4B4ITS", "WA4B5ITS", "WA4B6ITS",
  "WA5B1ITS", "WA5B2ITS", "WA5B3ITS", "WA5B4ITS", "WA5B5ITS", "WA5B6ITS",
  "WA7B1ITS", "WA7B2ITS", "WA7B3ITS",
  "WA8B1ITS", "WA8B2ITS", "WA8B3ITS",
  "WA9B1ITS", "WA9B2ITS", "WA9B3ITS",
  "WA10B1ITS", "WA10B2ITS", "WA10B3ITS",
  "WA11B1ITS", "WA11B2ITS", "WA11B3ITS",
  "WA12B1ITS", "WA12B2ITS", "WA12B3ITS"
)


# Combine your sample IDs into one desired order
ordered_ids <- c(lkd, w_order)
```

Filtering 
```{r}
# 1. Prevalence filtering for beta and differential abnudance testing - HIGHLY RECOMMENDED --------
# Get total number of samples
total_samples <- nsamples(ps_filtered01)
# Define minimum number of samples a taxon must be present in (e.g. ≥10% = 0.1)
min_prevalence <- ceiling(0.05 * total_samples)
# Filter taxa based on prevalence
ps_filtered02 <- filter_taxa(ps_filtered01, function(x) sum(x > 0) >= min_prevalence, prune = TRUE)

# Check how many taxa you removed
cat("Before filtering:", ntaxa(ps), "taxa\n") # 4454 
cat("After filtering:", ntaxa(ps_filt), "taxa\n") # 4454 
cat("After filtering:", ntaxa(ps_filtered01), "taxa\n") # 2306 
cat("After filtering:", ntaxa(ps_filtered02), "taxa\n") #  656  taxa
```

Define a function to generate and save barplots for any taxonomic level

```{r}
plot_taxonomic_barplot <- function(ps_obj, taxrank, n_taxa = 20, file_suffix = NULL, 
                                   width = 10, height = 8, unknowns = c("Incertae Sedis", "NA", "Unknown family"),
                                   facet_var = "Tissue_health", sample_order = ordered_ids) {
  
  # Clean taxonomy labels
  ps_obj <- tax_fix(ps_obj,
                    min_length = 5,
                    unknowns = unknowns,
                    sep = " ",
                    anon_unique = TRUE,
                    suffix_rank = "classified")
  
  # Agglomerate to desired taxonomic level if not Phylum
  if (taxrank != "Phylum") {
    ps_obj <- tax_glom(ps_obj, taxrank = taxrank, NArm = FALSE)
  }
  
  # Transform to compositional abundance
  ps_obj <- microbiome::transform(ps_obj, "compositional")
  
  # Clean taxonomy prefixes and unclassifieds
  tax_tab <- as.data.frame(tax_table(ps_obj))
  tax_tab[] <- lapply(tax_tab, function(x) gsub("^(k__|p__|c__|o__|f__|g__|s__)", "", x))
  tax_tab[] <- lapply(tax_tab, function(x) ifelse(x == "" | is.na(x), "Unclassified", x))
  tax_table(ps_obj) <- as.matrix(tax_tab)
  
  # Create file name suffix if none provided
  if (is.null(file_suffix)) file_suffix <- tolower(taxrank)
  
  # Create output paths
  pdf_path <- sprintf("/rds/homes/k/kgh742/psf_wgs_project/02.MicrobiomeAnalysis/ITS_Figures/composition_barplots/test_scripts/barplot_test_%s.pdf", file_suffix)
  csv_path <- sprintf("/rds/homes/k/kgh742/psf_wgs_project/02.MicrobiomeAnalysis/ITS_Figures/composition_barplots/test_scripts/%s_taxa_summary_test.csv", file_suffix)
  
  # Open PDF
  pdf(pdf_path, width = width, height = height)
  
  # Generate plot
  p <- ps_obj %>%
    comp_barplot(
      tax_level = taxrank,
      n_taxa = n_taxa,
      other_name = "Other",
      order_with_all_taxa = TRUE,
      merge_other = TRUE,
      bar_width = 0.7,
      bar_outline_colour = "grey5",
      facet_by = facet_var,
      sample_order = sample_order
    ) +
    coord_flip() +
    guides(fill = guide_legend(ncol = 1)) +
    theme(
      legend.text = element_text(size = 8),
      legend.title = element_text(size = 9),
      legend.key.size = unit(0.5, "lines"),
      panel.background = element_rect(fill = "white", colour = "black"),
      panel.border = element_rect(colour = "black", fill = NA, size = 0.5)
    )
  
  print(p)
  dev.off()
  
  # Save summary CSV
  tx_sum <- taxa_summary(ps_obj, taxrank)
  write_csv(tx_sum, csv_path)
  
  message(sprintf("Saved %s-level plot and data to:\n%s\n%s", taxrank, pdf_path, csv_path))
}

# -----------------------------------
# Run once per taxonomic level:
# -----------------------------------

plot_taxonomic_barplot(ps_filtered02, "Phylum", n_taxa = 15)
plot_taxonomic_barplot(ps_filtered02, "Class", n_taxa = 15)
plot_taxonomic_barplot(ps_filtered02, "Order", n_taxa = 15)
plot_taxonomic_barplot(ps_filtered02, "Family", n_taxa = 20)
plot_taxonomic_barplot(ps_filtered02, "Genus", n_taxa = 30)

```                      
